#include "include/Game/Map/Map.h"

#include "include/Window.h"

Map::Map() {
    m_name = "undefined";
    m_height = 0;
    m_width = 0;
}

Map::~Map() {}

void Map::init(const std::string& mname) {
    m_name = mname;
    
    createTestMap(); // to be modified later
}

void Map::update() {
    updateLayer(LayerID::FOAM);
    updateLayer(LayerID::SAND);
    updateLayer(LayerID::STONE);
    updateLayer(LayerID::GRASS);

    for (Entity* e : entities)
        e->update();
}

void Map::render() {
    renderLayer(LayerID::FOAM);
    renderLayer(LayerID::SAND);
    renderLayer(LayerID::STONE);
    renderLayer(LayerID::GRASS);

    for (Entity* e : entities)
        e->draw();
}

void Map::destroy() {
    for (Entity* e : entities) {
        e->kill();
        delete e;
    }
    entities.clear();

    destroyLayer(LayerID::FOAM);
    destroyLayer(LayerID::SAND);
    destroyLayer(LayerID::STONE);
    destroyLayer(LayerID::GRASS);
    
    m_name = "undefined";
    m_height = 0;
    m_width = 0;
}

int Map::width() {
    return m_width * Tile::SIZE;
}

int Map::height() {
    return m_height * Tile::SIZE;
}

void Map::addTile(const LayerID lid, const int x, const int y, const Tile::Type ttype) {
    if (ttype == Tile::Type::NONE) return;

    if (ttype == Tile::Type::FOAM) {
        Foam* t = new Foam();
        t->place(x, y);
        layers[lid].push_back(t);

    }
    else {
        Tile* t = new Tile(ttype);
        t->place(x, y);
        layers[lid].push_back(t);
    }
}

void Map::create(const int w, const int h, const std::array<RawLayer, NUMBER_OF_LAYER>& rmap) {
    m_width = w;
    m_height = h;

    createLayer(LayerID::FOAM, rmap[LayerID::FOAM]);
    createLayer(LayerID::SAND, rmap[LayerID::SAND]);
    createLayer(LayerID::STONE, rmap[LayerID::STONE]);
    createLayer(LayerID::GRASS, rmap[LayerID::GRASS]);
}

void Map::createLayer(const LayerID lid, const RawLayer& rlayer) {
    for (int y = 0; y < m_height; y++)
        for (int x = 0; x < m_width; x++)
            addTile(lid, x, y, Tile::Type(rlayer[y][x]));
}

void Map::updateLayer(const LayerID lid) {
    for (auto t : layers[lid])
        t->update();
}

void Map::renderLayer(const LayerID lid) {
    for (auto t : layers[lid])
        t->draw();
}

void Map::destroyLayer(const LayerID lid) {
    for (auto t : layers[lid])
        t->destroy();
    layers[lid].clear();
}

void Map::createTestMap() {
    const RawLayer foamLayer = {
        {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 2, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 2, 0, 0, 0, 0, 0, 2, 0, 2, 2, 0, 2, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 2, 2, 0, 0, 0, 2, 2, 0, 0, 2, 2, 2, 2, 2, 2, 0, 2, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
        {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    };

    const RawLayer sandLayer = {
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0, 21,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 22,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 25,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0, 27, 23, 23,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 25,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0, 24, 23, 23, 23, 23, 23,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 25,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0, 21, 23, 23, 23, 23, 23, 23,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 23, 28,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0, 24, 23, 23, 23, 23, 23, 23,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 25,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0, 24,  0,  0,  0,  0,  0, 23, 23, 23, 23,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 23, 22,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0, 24, 23, 23, 23, 23, 23, 23, 23, 23, 23,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 25,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0, 27, 26, 26, 26, 26, 23, 23, 23, 23, 28,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 25,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 27, 26, 26, 28,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 23, 23, 28,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0, 19,  0, 21, 22,  0,  0,  0,  0,  0, 19,  0,  0,  0,  0,  0, 23, 23, 23, 23, 23, 23, 28,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 27, 26, 30,  0, 31, 30,  0,  0,  0,  0,  0,  0,  0, 27, 26, 26, 26, 26, 28,  0, 19,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
    };

    const RawLayer stoneLayer = {
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0, 37, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 38,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0, 40,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 41,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0, 43, 39,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 41,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0, 52, 43, 42, 42, 42, 42, 39,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 41,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 52, 53, 53, 53, 53, 40,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 39, 44,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 40,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 39, 54,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0, 37, 36, 36, 36, 36, 36, 42, 42, 42, 39,  0,  0,  0,  0,  0,  0,  0,  0,  0, 41,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0, 43, 42, 42, 42, 42, 44, 53, 53, 53, 43, 42, 42, 42, 39,  0,  0,  0,  0,  0, 39, 38,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0, 52, 53, 53, 53, 53, 54,  0,  0,  0, 52, 53, 53, 53, 40,  0,  0,  0,  0,  0,  0, 41,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 40,  0,  0,  0,  0, 39, 42, 44,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 37, 38,  0, 43, 42, 42, 42, 42, 44, 53, 54,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 43, 44,  0, 52, 53, 53, 53, 53, 54,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 52, 54,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
    };

    const RawLayer grassLayer = {
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  5,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  4,  6,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  8,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  9,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0, 11,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  9,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 11, 10, 10, 10, 10,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  9,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  8,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7, 12,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  8,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  9,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  5,  4,  4,  4,  4,  4, 10, 10, 10,  7,  7,  7,  7,  7,  7,  7,  7,  7,  7,  9,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0, 11, 10, 10, 10, 10, 12,  0,  0,  0, 11, 10, 10, 10,  7,  7,  7,  7,  7,  7,  7,  6,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  8,  7,  7,  7,  7,  7,  7,  9,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  8,  7,  7,  7,  7,  7, 10, 12,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  5,  6,  0, 11, 10, 10, 10, 10, 12,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 11, 12,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
        { 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
    };

    const std::array<RawLayer, NUMBER_OF_LAYER> rmap = {
        foamLayer,
        sandLayer,
        stoneLayer,
        grassLayer,
    };
    create(33, 17, rmap);

    Entity* p1 = new Entity();
    p1->placeAt(15, 5);
    entities.push_back(p1);

    Entity* p2 = new Entity();
    p2->placeAt(18, 8);
    entities.push_back(p2);
}
